name: Upload Thirdparty Branch(es) To Latest Release

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Select a branch or choose 'all'"
        required: true
        type: choice
        options:
          - all
          - thirdparty-windows-amd64
          - thirdparty-windows-arm64
          - thirdparty-linux-arm64
          - thirdparty-linux-amd64
          - thirdparty-macos-arm64
          - thirdparty-macos-amd64
          - thirdparty-linuxmusl-arm64
          - thirdparty-linuxmusl-amd64

jobs:
  package-and-upload:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Determine branches to process
        id: branches
        run: |
          if [ "${{ github.event.inputs.branch }}" = "all" ]; then
            echo "branches=thirdparty-windows-amd64 thirdparty-windows-arm64 thirdparty-linux-arm64 thirdparty-linux-amd64 thirdparty-macos-arm64 thirdparty-macos-amd64 thirdparty-linuxmusl-arm64 thirdparty-linuxmusl-amd64" >> $GITHUB_OUTPUT
          else
            echo "branches=${{ github.event.inputs.branch }}" >> $GITHUB_OUTPUT
          fi

      - name: Get latest release info
        id: release
        run: |
          RELEASE_JSON=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/releases/latest)

          echo "upload_url=$(echo $RELEASE_JSON | jq -r .upload_url | sed 's/{?name,label}//')" >> $GITHUB_OUTPUT

      - name: Process branches
        run: |
          for BRANCH in ${{ steps.branches.outputs.branches }}
          do
            echo "Processing $BRANCH"

            git clone --depth 1 --branch "$BRANCH" https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} repo
            cd repo

            NAME="${BRANCH#thirdparty-}"
            ZIP_NAME="${NAME}.zip"

            zip -r "../$ZIP_NAME" . -x ".git/*"
            cd ..
            rm -rf repo

            # Delete existing asset if present
            ASSET_ID=$(curl -s \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              https://api.github.com/repos/${{ github.repository }}/releases/latest \
              | jq ".assets[] | select(.name == \"$ZIP_NAME\") | .id")

            if [ ! -z "$ASSET_ID" ]; then
              curl -X DELETE \
                -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github+json" \
                https://api.github.com/repos/${{ github.repository }}/releases/assets/$ASSET_ID
            fi

            # Upload asset
            curl -X POST \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "Content-Type: application/zip" \
              --data-binary @"$ZIP_NAME" \
              "${{ steps.release.outputs.upload_url }}?name=$ZIP_NAME"

            rm -f "$ZIP_NAME"
          done
